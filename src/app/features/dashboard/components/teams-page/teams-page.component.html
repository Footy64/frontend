<section class="teams">
  <header class="teams__hero">
    <div>
      <p class="teams__eyebrow">Collectif</p>
      <h1>Structure tes equipes en quelques minutes</h1>
      <p>Invite des joueurs par display name et garde un roster clair.</p>
    </div>
    <div class="teams__hero-pill">
      {{ selectedMembers.length }} joueur{{ selectedMembers.length > 1 ? 's' : '' }} preselectionne{{ selectedMembers.length > 1 ? 's' : '' }}
    </div>
  </header>

  <div class="teams__grid">
    <article class="teams__builder">
      <header>
        <p class="teams__eyebrow">Nouvelle equipe</p>
        <h2>Compose ton roster</h2>
      </header>
      <form [formGroup]="createTeamForm" (ngSubmit)="createTeam()" class="teams__form">
        <label class="teams__field">
          <span>Nom</span>
          <input
            id="team-name"
            type="text"
            maxlength="64"
            formControlName="name"
            placeholder="Ex : FC Footy"
          />
          <p *ngIf="createTeamForm.get('name')?.touched && createTeamForm.get('name')?.hasError('required')" class="teams__error">
            Choisis un nom.
          </p>
        </label>

        <div class="teams__autocomplete">
          <app-user-autocomplete
            label="Inviter des joueurs"
            placeholder="Rechercher par display name"
            hint="Selectionne un joueur puis clique sur +"
            [selectedUserIds]="selectedMemberIds"
            (userSelected)="onCreateMemberSelected($event)"
          ></app-user-autocomplete>
        </div>

        <section class="teams__roster">
          <header>
            <span>Roster</span>
            <span>{{ selectedMembers.length }} joueur{{ selectedMembers.length > 1 ? 's' : '' }}</span>
          </header>
          <div *ngIf="selectedMembers.length; else emptyRoster" class="teams__chips">
            <div *ngFor="let member of selectedMembers" class="teams__chip">
              <span>{{ member.displayName || member.email }}</span>
              <button type="button" (click)="removeSelectedMember(member.id)" [disabled]="isCreatingTeam">&times;</button>
            </div>
          </div>
          <ng-template #emptyRoster>
            <p class="teams__muted">Ajoute des joueurs via la recherche ci-dessus.</p>
          </ng-template>
        </section>

        <div class="teams__actions">
          <button type="submit" [disabled]="isCreatingTeam" class="teams__primary">
            {{ isCreatingTeam ? 'Creation...' : 'Creer l\'equipe' }}
          </button>
          <span *ngIf="teamFeedback as feedback" [ngClass]="feedback.type === 'success' ? 'teams__success' : 'teams__error'">
            {{ feedback.message }}
          </span>
        </div>
      </form>
    </article>

    <article class="teams__library">
      <header>
        <p class="teams__eyebrow">Mes equipes</p>
        <h2>Gerer rosters et invitations</h2>
      </header>
      <ng-container *ngIf="isLoadingTeams$ | async; else teamsContent">
        <p class="teams__muted">Chargement des equipes...</p>
      </ng-container>
      <ng-template #teamsContent>
        <ng-container *ngIf="teams$ | async as teams">
          <p *ngIf="!teams.length" class="teams__muted">Aucune equipe pour le moment.</p>
          <div *ngIf="teams.length" class="teams__list">
            <div *ngFor="let team of teams; trackBy: trackByTeamId" class="teams__card">
              <div class="teams__card-head">
                <div>
                  <p>Equipe</p>
                  <h3>{{ team.name }}</h3>
                </div>
                <span>{{ team.members.length }} joueur{{ team.members.length > 1 ? 's' : '' }}</span>
              </div>
              <div class="teams__members">
                <p>Joueurs</p>
                <div *ngIf="team.members.length; else noMembers" class="teams__chips">
                  <div *ngFor="let member of team.members" class="teams__chip">
                    <span>{{ member.displayName || member.email }}</span>
                    <button type="button" (click)="removeMember(team, member)" [disabled]="isMemberActionLoading(team.id)">&times;</button>
                  </div>
                </div>
                <ng-template #noMembers>
                  <p class="teams__muted">Aucun joueur pour le moment.</p>
                </ng-template>
              </div>
              <div class="teams__autocomplete">
                <app-user-autocomplete
                  label="Ajouter un joueur"
                  placeholder="Rechercher par display name"
                  hint="Clique sur le + pour inviter le joueur"
                  [disabled]="isMemberActionLoading(team.id)"
                  [selectedUserIds]="memberIds(team)"
                  (userSelected)="addMemberToTeam(team, $event)"
                ></app-user-autocomplete>
              </div>
              <p *ngIf="isMemberActionLoading(team.id)" class="teams__muted">Synchronisation...</p>
            </div>
          </div>
        </ng-container>
      </ng-template>
    </article>
  </div>
</section>
