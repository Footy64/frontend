<section class="matches">
  <header class="matches__hero">
    <div>
      <p class="matches__eyebrow">Planification</p>
      <h1>Organise un nouveau match</h1>
      <p>Selectionne deux equipes distinctes, une date et un lieu.</p>
    </div>
  </header>

  <div class="matches__grid">
    <article class="matches__planner">
      <form [formGroup]="createMatchForm" (ngSubmit)="createMatch()" class="matches__form">
        <div class="matches__field-group">
          <label>
            <span>Equipe a domicile</span>
            <select formControlName="homeTeamId">
              <option [ngValue]="null" disabled>Choisir une equipe</option>
              <option *ngFor="let team of (teams$ | async) ?? []" [value]="team.id">
                {{ team.name }}
              </option>
            </select>
          </label>
          <label>
            <span>Equipe visiteuse</span>
            <select formControlName="awayTeamId">
              <option [ngValue]="null" disabled>Choisir une equipe</option>
              <option *ngFor="let team of (teams$ | async) ?? []" [value]="team.id">
                {{ team.name }}
              </option>
            </select>
          </label>
        </div>
        <p *ngIf="createMatchForm.hasError('sameTeams')" class="matches__error">
          Les equipes doivent etre differentes.
        </p>
        <div class="matches__field-group">
          <label>
            <span>Date et heure</span>
            <input type="datetime-local" formControlName="date" />
          </label>
          <label>
            <span>Lieu</span>
            <input type="text" placeholder="Ex : Stade Auguste-Delaune" formControlName="place" />
          </label>
        </div>
        <div class="matches__actions">
          <button type="submit" class="matches__primary" [disabled]="isCreatingMatch || ((teams$ | async)?.length ?? 0) < 2">
            {{ isCreatingMatch ? 'Planification...' : 'Creer le match' }}
          </button>
          <span *ngIf="matchFeedback as feedback" [ngClass]="feedback.type === 'success' ? 'matches__success' : 'matches__error'">
            {{ feedback.message }}
          </span>
        </div>
      </form>
    </article>

    <article class="matches__schedule">
      <header>
        <p class="matches__eyebrow">Matchs programmes</p>
        <h2>Scores et feuille de match</h2>
      </header>
      <ng-container *ngIf="isLoadingMatches$ | async; else scheduleContent">
        <p class="matches__muted">Chargement des matchs...</p>
      </ng-container>
      <ng-template #scheduleContent>
        <ng-container *ngIf="matches$ | async as matches">
          <p *ngIf="!matches.length" class="matches__muted">Aucun match pour le moment.</p>
          <div *ngIf="matches.length" class="matches__list">
            <div *ngFor="let match of matches; trackBy: trackByMatchId" class="matches__item">
              <div class="matches__item-head">
                <strong>{{ match.homeTeam.name }} vs {{ match.awayTeam.name }}</strong>
                <p>{{ match.place }} · {{ match.date | date: 'short' }}</p>
              </div>
              <form [formGroup]="getScoreForm(match.id)" (ngSubmit)="updateScore(match)" class="matches__score">
                <label>
                  <span>{{ match.homeTeam.name }}</span>
                  <input type="number" min="0" formControlName="homeScore" />
                </label>
                <label>
                  <span>{{ match.awayTeam.name }}</span>
                  <input type="number" min="0" formControlName="awayScore" />
                </label>
                <div class="matches__score-actions">
                  <button type="submit" [disabled]="isScoreActionLoading(match.id)">
                    {{ isScoreActionLoading(match.id) ? 'Enregistrement...' : 'Mettre a jour le score' }}
                  </button>
                  <span *ngIf="scoreFeedbacks.get(match.id) as feedback" [ngClass]="feedback.type === 'success' ? 'matches__success' : 'matches__error'">
                    {{ feedback.message }}
                  </span>
                </div>
              </form>
            </div>
          </div>
        </ng-container>
      </ng-template>
    </article>
  </div>
</section>
